import React, { useState, useEffect } from 'react';
import { CheckCircle, XCircle, ArrowRight, RotateCcw, Award, BookOpen, UserPlus, MessageSquare, Zap } from 'lucide-react';

const SolaraGame = () => {
  const [gameState, setGameState] = useState('intro'); // intro, blitz, scenarios, summary
  const [score, setScore] = useState(0);
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [feedback, setFeedback] = useState(null); // null, 'correct', 'incorrect'
  const [feedbackMessage, setFeedbackMessage] = useState('');

  // --- GAME DATA ---

  const blitzData = [
    {
      id: 1,
      text: "Use plain, direct language in your prompts.",
      type: "do",
      explanation: "Solara performs best when requests are direct and easy to understand."
    },
    {
      id: 2,
      text: "Type a student's name in the prompt to automatically search their records.",
      type: "dont",
      explanation: "Solara does NOT search records automatically. You must manually use the 'Add student(s)' button."
    },
    {
      id: 3,
      text: "Treat the first output as a draft and ask for revisions.",
      type: "do",
      explanation: "Solara is designed for back-and-forth refinement. Iterate to get the best result."
    },
    {
      id: 4,
      text: "Write prompts like 'Fix this' or 'Help me with a lesson'.",
      type: "dont",
      explanation: "Vague prompts lead to generic responses. Be specific about components and goals."
    },
    {
      id: 5,
      text: "Include context like grade level, student needs (IEP/ELL), and instructional goals.",
      type: "do",
      explanation: "Giving context ensures the response is tailored to your specific audience."
    }
  ];

  const scenarioData = [
    {
      id: 1,
      title: "The Lesson Plan",
      problem: "You need a lesson plan for 5th grade science, but you have specific requirements.",
      badPrompt: "Create a lesson about photosynthesis.",
      options: [
        {
          text: "Create a 45-minute lesson on photosynthesis for 5th graders including a hands-on activity and assessment.",
          correct: true,
          reason: "Perfect! This specifies the duration, grade level, topic, and required components."
        },
        {
          text: "Tell me about photosynthesis for kids.",
          correct: false,
          reason: "Too vague. It lacks structure, duration, and specific learning objectives."
        }
      ]
    },
    {
      id: 2,
      title: "The Parent Email",
      problem: "You need to email parents about an upcoming field trip, but the tone matters.",
      badPrompt: "Write an email to families about the trip.",
      options: [
        {
          text: "Draft a permission slip email.",
          correct: false,
          reason: "Still too brief. It misses the tone and specific constraints."
        },
        {
          text: "Write a friendly, informative email to families about the Zoo trip next Tuesday, emphasizing safety and lunch details.",
          correct: true,
          reason: "Excellent. This provides context (Zoo/Tuesday), purpose, and defines the tone (friendly/informative)."
        }
      ]
    },
    {
      id: 3,
      title: "Data Analysis",
      problem: "You want Solara to analyze Jamie's reading progress based on stored data.",
      badPrompt: "How is Jamie doing in reading?",
      options: [
        {
          text: "Type: 'Analyze reading progress for Jamie' while ensuring Jamie is added via the 'Add Student' button.",
          correct: true,
          reason: "Correct! You must manually add individual students to the chat for analysis."
        },
        {
          text: "Type: 'Look up Jamie's files and tell me his reading level.'",
          correct: false,
          reason: "Solara cannot 'look up' files unless the student is explicitly added to the context window first."
        }
      ]
    }
  ];

  // --- LOGIC HANDLERS ---

  const startGame = () => {
    setGameState('blitz');
    setScore(0);
    setCurrentQuestion(0);
    setFeedback(null);
  };

  const handleBlitzAnswer = (selection) => {
    const currentQ = blitzData[currentQuestion];
    const isCorrect = selection === currentQ.type;

    if (isCorrect) {
      setScore(score + 100);
      setFeedback('correct');
      setFeedbackMessage(`Correct! ${currentQ.explanation}`);
    } else {
      setFeedback('incorrect');
      setFeedbackMessage(`Oops! Actually, that's a "${currentQ.type === 'do' ? 'Do' : "Don't"}". ${currentQ.explanation}`);
    }
  };

  const nextBlitz = () => {
    setFeedback(null);
    if (currentQuestion < blitzData.length - 1) {
      setCurrentQuestion(currentQuestion + 1);
    } else {
      setGameState('intermission');
    }
  };

  const startScenarios = () => {
    setGameState('scenarios');
    setCurrentQuestion(0);
    setFeedback(null);
  };

  const handleScenarioAnswer = (option) => {
    if (option.correct) {
      setScore(score + 200);
      setFeedback('correct');
      setFeedbackMessage(option.reason);
    } else {
      setFeedback('incorrect');
      setFeedbackMessage(option.reason);
    }
  };

  const nextScenario = () => {
    setFeedback(null);
    if (currentQuestion < scenarioData.length - 1) {
      setCurrentQuestion(currentQuestion + 1);
    } else {
      setGameState('summary');
    }
  };

  // --- COMPONENTS ---

  const Header = () => (
    <div className="w-full flex justify-between items-center p-4 bg-indigo-900 text-white shadow-md">
      <div className="flex items-center gap-2">
        <Zap className="text-yellow-400" size={24} />
        <h1 className="font-bold text-xl tracking-tight">Solara Prompt Master</h1>
      </div>
      <div className="bg-indigo-800 px-4 py-1 rounded-full font-mono text-sm border border-indigo-600">
        Score: {score}
      </div>
    </div>
  );

  const IntroScreen = () => (
    <div className="flex flex-col items-center justify-center min-h-[60vh] text-center p-6 space-y-6 max-w-2xl mx-auto">
      <div className="bg-indigo-100 p-6 rounded-full">
        <MessageSquare size={64} className="text-indigo-600" />
      </div>
      <h2 className="text-3xl font-bold text-gray-800">Master the Art of Prompting</h2>
      <p className="text-gray-600 text-lg">
        Effective prompting is key to getting actionable responses from Solara. 
        Learn the <span className="font-bold text-green-600">Dos</span> and <span className="font-bold text-red-600">Don'ts</span> to become a power user.
      </p>
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-left w-full mt-4">
        <div className="p-4 bg-white shadow-sm rounded-lg border border-gray-200">
          <h3 className="font-bold text-indigo-600 mb-1">1. Be Clear</h3>
          <p className="text-sm text-gray-500">Avoid vague jargon. State your task plainly.</p>
        </div>
        <div className="p-4 bg-white shadow-sm rounded-lg border border-gray-200">
          <h3 className="font-bold text-indigo-600 mb-1">2. Give Context</h3>
          <p className="text-sm text-gray-500">Mention grade level, tone, and specific constraints.</p>
        </div>
        <div className="p-4 bg-white shadow-sm rounded-lg border border-gray-200">
          <h3 className="font-bold text-indigo-600 mb-1">3. Iterate</h3>
          <p className="text-sm text-gray-500">Treat outputs as drafts. Co-edit with Solara.</p>
        </div>
      </div>
      <button 
        onClick={startGame}
        className="mt-8 px-8 py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition flex items-center gap-2 shadow-lg"
      >
        Start Training <ArrowRight size={20} />
      </button>
    </div>
  );

  const BlitzMode = () => {
    const item = blitzData[currentQuestion];
    return (
      <div className="max-w-xl mx-auto mt-10 p-4">
        <div className="text-center mb-6">
          <h3 className="text-indigo-900 font-bold uppercase tracking-wider text-sm mb-2">
            Round 1: Quick Sort
          </h3>
          <div className="w-full bg-gray-200 rounded-full h-2">
            <div 
              className="bg-indigo-600 h-2 rounded-full transition-all duration-300" 
              style={{ width: `${((currentQuestion) / blitzData.length) * 100}%` }}
            ></div>
          </div>
        </div>

        <div className="bg-white rounded-xl shadow-xl p-8 min-h-[300px] flex flex-col items-center justify-center text-center relative overflow-hidden border border-gray-100">
          {feedback ? (
            <div className={`absolute inset-0 flex flex-col items-center justify-center p-6 ${feedback === 'correct' ? 'bg-green-50' : 'bg-red-50'}`}>
              {feedback === 'correct' ? <CheckCircle size={64} className="text-green-500 mb-4" /> : <XCircle size={64} className="text-red-500 mb-4" />}
              <p className={`text-xl font-bold mb-2 ${feedback === 'correct' ? 'text-green-800' : 'text-red-800'}`}>
                {feedback === 'correct' ? 'That\'s right!' : 'Not quite.'}
              </p>
              <p className="text-gray-700 mb-6">{feedbackMessage}</p>
              <button onClick={nextBlitz} className="px-6 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900">
                Next Card
              </button>
            </div>
          ) : (
            <>
              <p className="text-2xl font-medium text-gray-800 mb-8 leading-snug">
                "{item.text}"
              </p>
              <div className="flex gap-4 w-full">
                <button 
                  onClick={() => handleBlitzAnswer('do')}
                  className="flex-1 py-4 rounded-xl border-2 border-green-500 text-green-600 font-bold text-lg hover:bg-green-50 transition"
                >
                  DO
                </button>
                <button 
                  onClick={() => handleBlitzAnswer('dont')}
                  className="flex-1 py-4 rounded-xl border-2 border-red-500 text-red-600 font-bold text-lg hover:bg-red-50 transition"
                >
                  DON'T
                </button>
              </div>
            </>
          )}
        </div>
      </div>
    );
  };

  const Intermission = () => (
    <div className="max-w-xl mx-auto mt-10 p-6 text-center bg-white rounded-xl shadow-lg border-t-4 border-indigo-500">
      <Award size={48} className="mx-auto text-indigo-500 mb-4" />
      <h2 className="text-2xl font-bold text-gray-800 mb-2">Round 1 Complete!</h2>
      <p className="text-gray-600 mb-6">Current Score: {score}</p>
      <p className="text-lg text-gray-800 mb-6">
        Next up: <strong>The Fixer</strong>. <br/>
        You'll see a vague request. Choose the prompt that best applies context, clarity, and constraints.
      </p>
      <button 
        onClick={startScenarios}
        className="px-8 py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition"
      >
        Start Round 2
      </button>
    </div>
  );

  const ScenarioMode = () => {
    const item = scenarioData[currentQuestion];
    return (
      <div className="max-w-2xl mx-auto mt-6 p-4">
        <div className="text-center mb-6">
          <h3 className="text-indigo-900 font-bold uppercase tracking-wider text-sm mb-2">
            Round 2: The Fixer
          </h3>
          <div className="w-full bg-gray-200 rounded-full h-2">
            <div 
              className="bg-indigo-600 h-2 rounded-full transition-all duration-300" 
              style={{ width: `${((currentQuestion) / scenarioData.length) * 100}%` }}
            ></div>
          </div>
        </div>

        <div className="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
          {/* Scenario Header */}
          <div className="bg-gray-50 p-6 border-b border-gray-100">
            <h2 className="text-xl font-bold text-gray-800 mb-2">{item.title}</h2>
            <div className="flex items-start gap-3 text-gray-600 mb-4 bg-blue-50 p-3 rounded-lg border border-blue-100">
              <BookOpen size={20} className="mt-1 text-blue-500 shrink-0" />
              <p className="text-sm">{item.problem}</p>
            </div>
            
            <div className="flex flex-col gap-2">
              <p className="text-xs font-bold text-red-500 uppercase tracking-wide">Avoid This:</p>
              <div className="bg-red-50 text-red-800 p-3 rounded border-l-4 border-red-400 italic">
                "{item.badPrompt}"
              </div>
            </div>
          </div>

          {/* Interaction Area */}
          <div className="p-6">
            {feedback ? (
               <div className={`p-6 rounded-lg ${feedback === 'correct' ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}`}>
               <div className="flex items-center gap-3 mb-3">
                 {feedback === 'correct' ? <CheckCircle className="text-green-600" /> : <XCircle className="text-red-600" />}
                 <h3 className={`font-bold text-lg ${feedback === 'correct' ? 'text-green-800' : 'text-red-800'}`}>
                   {feedback === 'correct' ? 'Excellent Choice!' : 'Needs Improvement'}
                 </h3>
               </div>
               <p className="text-gray-700 mb-6">{feedbackMessage}</p>
               <button onClick={nextScenario} className="w-full py-3 bg-gray-800 text-white rounded-lg hover:bg-gray-900 font-semibold">
                 Continue
               </button>
             </div>
            ) : (
              <div>
                <p className="mb-4 font-semibold text-gray-700">Which is the better prompt?</p>
                <div className="space-y-3">
                  {item.options.map((option, idx) => (
                    <button
                      key={idx}
                      onClick={() => handleScenarioAnswer(option)}
                      className="w-full text-left p-4 rounded-lg border-2 border-gray-200 hover:border-indigo-500 hover:bg-indigo-50 transition group"
                    >
                      <div className="flex items-start gap-3">
                        <div className="bg-white border border-gray-300 rounded-full w-6 h-6 flex items-center justify-center shrink-0 mt-0.5 group-hover:border-indigo-500">
                          <span className="text-xs font-bold text-gray-500 group-hover:text-indigo-600">{idx === 0 ? 'A' : 'B'}</span>
                        </div>
                        <span className="text-gray-800">{option.text}</span>
                      </div>
                    </button>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    );
  };

  const SummaryScreen = () => (
    <div className="max-w-2xl mx-auto mt-10 p-8 bg-white rounded-xl shadow-xl text-center">
      <div className="inline-block p-4 rounded-full bg-yellow-100 mb-6">
        <Award size={64} className="text-yellow-600" />
      </div>
      <h2 className="text-3xl font-bold text-gray-800 mb-2">Training Complete!</h2>
      <p className="text-xl text-gray-600 mb-8">Final Score: <span className="font-bold text-indigo-600">{score}</span></p>

      <div className="bg-gray-50 rounded-xl p-6 text-left mb-8 border border-gray-200">
        <h3 className="font-bold text-gray-800 mb-4 border-b pb-2">Key Takeaways</h3>
        <ul className="space-y-4">
          <li className="flex items-start gap-3">
            <CheckCircle size={20} className="text-green-500 mt-1 shrink-0" />
            <div>
              <span className="font-bold text-gray-800">Be Specific:</span> Don't ask generic questions. Define the output format, length, and content.
            </div>
          </li>
          <li className="flex items-start gap-3">
            <CheckCircle size={20} className="text-green-500 mt-1 shrink-0" />
            <div>
              <span className="font-bold text-gray-800">Provide Context:</span> Include grade level, specific needs (IEP, ELL), and tone.
            </div>
          </li>
          <li className="flex items-start gap-3">
            <CheckCircle size={20} className="text-green-500 mt-1 shrink-0" />
            <div>
              <span className="font-bold text-gray-800">Add Students Correctly:</span> Typing a name isn't enough. Use the "Add Student" feature for data-driven prompts.
            </div>
          </li>
          <li className="flex items-start gap-3">
            <CheckCircle size={20} className="text-green-500 mt-1 shrink-0" />
            <div>
              <span className="font-bold text-gray-800">Iterate:</span> The first response is a draft. Co-edit and refine with follow-up prompts.
            </div>
          </li>
        </ul>
      </div>

      <button 
        onClick={startGame}
        className="px-6 py-3 border-2 border-indigo-600 text-indigo-600 font-bold rounded-lg hover:bg-indigo-50 transition flex items-center gap-2 mx-auto"
      >
        <RotateCcw size={20} /> Replay Training
      </button>
    </div>
  );

  return (
    <div className="min-h-screen bg-slate-100 font-sans pb-10">
      <Header />
      {gameState === 'intro' && <IntroScreen />}
      {gameState === 'blitz' && <BlitzMode />}
      {gameState === 'intermission' && <Intermission />}
      {gameState === 'scenarios' && <ScenarioMode />}
      {gameState === 'summary' && <SummaryScreen />}
    </div>
  );
};

export default SolaraGame;
